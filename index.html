<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë™íŒŒë²• íˆ¬ì ì „ëµ ë°±í…ŒìŠ¤í„°</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PapaParse (CSV Parser) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        /* ìˆ«ì ì…ë ¥ í™”ì‚´í‘œ ì œê±° */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        /* í…Œì´ë¸” ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        /* íƒ­ í™œì„±í™” ìŠ¤íƒ€ì¼ */
        .tab-active { border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: bold; }
        .tab-inactive { color: #6b7280; }
        .tab-inactive:hover { color: #374151; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- ë²„ì „ ì •ë³´ (ìš°ì¸¡ ìƒë‹¨) -->
    <div class="absolute top-2 right-2 text-[10px] text-gray-400 font-mono select-none">
        V1.0 (260106)
    </div>

    <!-- ê°„ë‹¨í•œ ë¹„ë°€ë²ˆí˜¸ ë³´í˜¸ (ì£¼ì„ ì²˜ë¦¬ë¨) -->
    <!-- <script> ... </script> -->

    <div class="container mx-auto p-4 max-w-[1400px]">
        <!-- í—¤ë” -->
        <header class="mb-4 text-center">
            <h1 class="text-3xl font-bold text-indigo-800 tracking-tight">ğŸŒŠ ë™íŒŒë²•(SOXL) ë°±í…ŒìŠ¤í„°</h1>
            <p class="text-sm text-gray-600 mt-2 font-medium">ì•ˆì „/ê³µì„¸ ëª¨ë“œ ê¸°ë°˜ ë™ì  ìì‚° ë°°ë¶„ ì „ëµ ì‹œë®¬ë ˆì´ì…˜</p>
            
            <!-- ë°ì´í„° ìƒíƒœ í‘œì‹œì¤„ -->
            <div class="flex justify-center items-center gap-3 mt-3">
                <span id="dbStatusBadge" class="flex items-center gap-2 text-sm font-bold text-gray-500 bg-white px-3 py-1 rounded-full shadow-sm">
                    <svg class="animate-spin h-4 w-4 text-indigo-500" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    ë°ì´í„° ì¤€ë¹„ ì¤‘...
                </span>
                <button onclick="loadFromGoogleSheet()" class="text-xs text-indigo-600 hover:text-indigo-800 font-bold underline">ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
                <label class="cursor-pointer text-xs text-gray-400 hover:text-gray-600 underline" title="êµ¬ê¸€ ì‹œíŠ¸ ì˜¤ë¥˜ ì‹œ ì‚¬ìš©">
                    CSV íŒŒì¼ ì„ íƒ
                    <input type="file" id="csvFile" accept=".csv" class="hidden">
                </label>
                <div id="manualDownloadLink" class="hidden text-xs text-red-500 bg-red-50 px-2 py-1 rounded">ë¡œë“œ ì‹¤íŒ¨.</div>
            </div>
        </header>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="flex border-b border-gray-200 mb-6">
            <button id="tabBtnBacktest" onclick="switchTab('backtest')" class="flex-1 py-3 text-center text-sm tab-active transition-colors">ğŸ“Š ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
            <button id="tabBtnOptimization" onclick="switchTab('optimization')" class="flex-1 py-3 text-center text-sm tab-inactive transition-colors">âš¡ íŒŒë¼ë¯¸í„° ìµœì í™”</button>
        </div>

        <!-- ==================== TAB 1: ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ==================== -->
        <div id="tabContentBacktest">
            <!-- ì„¤ì • íŒ¨ë„ (4ì—´ ë ˆì´ì•„ì›ƒ) -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
                
                <!-- 1. ê¸°ë³¸ ì„¤ì • -->
                <div class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-green-500">
                    <h2 class="font-bold text-lg mb-8 text-gray-700">1. ê¸°ë³¸ ì„¤ì •</h2>
                    <div class="space-y-4">
                        <!-- ì´ˆê¸° íˆ¬ìê¸ˆ & ìˆ˜ìˆ˜ë£Œ(êµ¬ì„) -->
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-xs font-bold text-gray-600">ì´ˆê¸° íˆ¬ìê¸ˆ ($)</label>
                                <!-- ìˆ˜ìˆ˜ë£Œ ë¯¸ë‹ˆ íŒ¨ë„ -->
                                <div class="flex items-center gap-2 bg-gray-50 px-2 py-0.5 rounded-md border border-gray-100">
                                    <div class="flex items-center gap-1">
                                        <span class="text-[10px] text-gray-400 font-medium">ìˆ˜ìˆ˜ë£Œ</span>
                                        <input type="number" id="brokerFee" value="0.044" step="0.001" class="w-9 text-[10px] text-right bg-transparent border-b border-gray-300 focus:border-green-500 outline-none text-gray-600">
                                        <span class="text-[10px] text-gray-400">%</span>
                                    </div>
                                    <div class="w-px h-2.5 bg-gray-300 mx-0.5"></div>
                                    <div class="flex items-center gap-1">
                                        <input type="checkbox" id="useSecFee" checked class="w-2.5 h-2.5 text-green-600 rounded focus:ring-green-500 border-gray-300 cursor-pointer">
                                        <label for="useSecFee" class="text-[10px] text-gray-400 cursor-pointer select-none">SEC</label>
                                    </div>
                                </div>
                            </div>
                            <input type="text" id="initialCapital" value="10,000" oninput="this.value = this.value.replace(/[^0-9]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ',');" class="w-full border border-gray-300 rounded px-2 py-1 text-right text-sm font-bold focus:ring-2 focus:ring-green-200 outline-none">
                        </div>

                        <!-- ë‚ ì§œ ì„¤ì • -->
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">ì‹œì‘ì¼</label>
                                <input type="date" id="startDate" value="2014-01-01" class="w-full border border-gray-300 rounded px-2 py-1 text-xs focus:ring-2 focus:ring-green-200 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">ì¢…ë£Œì¼</label>
                                <input type="date" id="endDate" class="w-full border border-gray-300 rounded px-2 py-1 text-xs focus:ring-2 focus:ring-green-200 outline-none">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. ëª¨ë“œë³„ ì„¤ì • -->
                <div class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-yellow-400">
                    <h2 class="font-bold text-lg mb-3 text-gray-700">2. ëª¨ë“œë³„ ì„¤ì • (%)</h2>
                    
                    <!-- ì•ˆì „ ëª¨ë“œ -->
                    <div class="mb-1 pb-2 border-b border-dashed border-gray-200">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-blue-600 flex items-center gap-1.5 text-sm">
                                <span class="w-2.5 h-2.5 rounded-full bg-blue-500"></span> ì•ˆì „ (SF)
                            </span>
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 mb-0.5 text-center">ë§¤ìˆ˜</label>
                                <input type="number" id="sfLoc" value="6.0" step="0.1" class="w-full border border-gray-300 rounded px-1 py-0.5 text-right text-sm font-bold text-gray-700 focus:ring-1 focus:ring-blue-400 outline-none">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 mb-0.5 text-center">ë§¤ë„</label>
                                <input type="number" id="sfProfit" value="1.8" step="0.1" class="w-full border border-gray-300 rounded px-1 py-0.5 text-right text-sm font-bold text-gray-700 focus:ring-1 focus:ring-blue-400 outline-none">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 mb-0.5 text-center">ë¶„í• </label>
                                <input type="number" id="sfSplit" value="7" class="w-full border border-gray-300 rounded px-1 py-0.5 text-right text-sm font-bold text-gray-700 focus:ring-1 focus:ring-blue-400 outline-none">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 mb-0.5 text-center">ë³´ìœ ì¼</label>
                                <input type="number" id="sfHold" value="40" class="w-full border border-gray-300 rounded px-1 py-0.5 text-right text-sm font-bold text-gray-700 focus:ring-1 focus:ring-blue-400 outline-none">
                            </div>
                        </div>
                    </div>

                    <!-- ê³µì„¸ ëª¨ë“œ -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-red-600 flex items-center gap-1.5 text-sm">
                                <span class="w-2.5 h-2.5 rounded-full bg-red-500"></span> ê³µì„¸ (AG)
                            </span>
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 mb-0.5 text-center">ë§¤ìˆ˜</label>
                                <input type="number" id="agLoc" value="3.6" step="0.1" class="w-full border border-gray-300 rounded px-1 py-0.5 text-right text-sm font-bold text-gray-700 focus:ring-1 focus:ring-red-400 outline-none">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 mb-0.5 text-center">ë§¤ë„</label>
                                <input type="number" id="agProfit" value="5.6" step="0.1" class="w-full border border-gray-300 rounded px-1 py-0.5 text-right text-sm font-bold text-gray-700 focus:ring-1 focus:ring-red-400 outline-none">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 mb-0.5 text-center">ë¶„í• </label>
                                <input type="number" id="agSplit" value="7" class="w-full border border-gray-300 rounded px-1 py-0.5 text-right text-sm font-bold text-gray-700 focus:ring-1 focus:ring-red-400 outline-none">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 mb-0.5 text-center">ë³´ìœ ì¼</label>
                                <input type="number" id="agHold" value="7" class="w-full border border-gray-300 rounded px-1 py-0.5 text-right text-sm font-bold text-gray-700 focus:ring-1 focus:ring-red-400 outline-none">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. íˆ¬ìê¸ˆ ê°±ì‹  ì„¤ì • -->
                <div class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-purple-500">
                    <h2 class="font-bold text-lg mb-3 text-gray-700">3. íˆ¬ìê¸ˆ ê°±ì‹  ì„¤ì •</h2>
                    <div class="space-y-3">
                        <!-- ê°±ì‹  ì£¼ê¸° -->
                        <div class="flex justify-between items-center border-b border-gray-100 pb-2 px-3">
                            <label class="text-xs font-bold text-gray-600">ê°±ì‹  ì£¼ê¸°</label>
                            <div class="flex items-center">
                                <input type="number" id="capitalCycle" value="10" class="w-16 border border-gray-300 rounded px-2 py-1 text-right text-sm focus:ring-2 focus:ring-purple-200 outline-none">
                                <span class="text-gray-500 text-xs ml-1 font-bold">ì¼</span>
                            </div>
                        </div>

                        <!-- ìˆ˜ìµ/ì†ì‹¤ ë°˜ì˜ë¥  -->
                        <div class="bg-purple-50 p-3 rounded-lg border border-purple-100 space-y-2">
                            <div class="flex justify-between items-center">
                                <label class="text-xs font-bold text-blue-700">ìˆ˜ìµ ì‹œ ë°˜ì˜ë¥ </label>
                                <div class="flex items-center">
                                    <input type="number" id="reinvestRate" value="85" class="w-14 border border-gray-300 rounded px-1 py-1 text-right text-sm font-bold text-blue-600 bg-white focus:ring-1 focus:ring-blue-400 outline-none">
                                    <span class="text-gray-500 text-[10px] ml-1">%</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <label class="text-xs font-bold text-red-600">ì†ì‹¤ ì‹œ ë°˜ì˜ë¥ </label>
                                <div class="flex items-center">
                                    <input type="number" id="lossRate" value="35" class="w-14 border border-gray-300 rounded px-1 py-1 text-right text-sm font-bold text-red-500 bg-white focus:ring-1 focus:ring-red-400 outline-none">
                                    <span class="text-gray-500 text-[10px] ml-1">%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. ì¸ì¶œì‹ ì„¤ì • (ì‹ ê·œ íŒ¨ë„) -->
                <div class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-indigo-400">
                    <h2 class="font-bold text-lg mb-1 text-gray-700">4. ì¸ì¶œì‹ ì„¤ì •</h2>
                    
                    <!-- ì–‘ë„ì„¸ ì¸ì¶œì „ëµ (ì—°ë‹¨ìœ„) ì²´í¬ë°•ìŠ¤ - mb-1ë¡œ ê°„ê²© ì¶•ì†Œ -->
                    <div class="flex items-center gap-2 mb-1">
                        <input type="checkbox" id="enableAnnualWithdrawal" onclick="toggleWithdrawalCheckboxes('annual')" class="w-4 h-4 text-pink-600 rounded focus:ring-pink-500 border-gray-300 cursor-pointer">
                        <label for="enableAnnualWithdrawal" class="text-xs font-medium text-gray-700 select-none font-bold">ì–‘ë„ì„¸ ì¸ì¶œì „ëµ ì‚¬ìš©</label>
                    </div>

                    <!-- ê¸°ì¡´ ì¸ì¶œì‹ ê¸°ëŠ¥ ì‚¬ìš© ì²´í¬ë°•ìŠ¤ - mb-2ë¡œ ê°„ê²© ìµœì†Œí™” -->
                    <div class="flex items-center gap-2 mb-2">
                        <input type="checkbox" id="enableWithdrawal" onclick="toggleWithdrawalCheckboxes('period')" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300 cursor-pointer">
                        <label for="enableWithdrawal" class="text-xs font-medium text-gray-700 select-none font-bold">ê¸°ê°„ ì¸ì¶œ ì‚¬ìš©</label>
                    </div>
                    
                    <!-- NEW: ì–‘ë„ì„¸ ìµœì í™” (22% ì´ˆê³¼ë¶„ ì¬ì…ê¸ˆ) ì²´í¬ë°•ìŠ¤ -->
                    <div class="flex items-center gap-2 mb-3 border-t pt-2 border-gray-300/50">
                        <input type="checkbox" id="enableTaxOpt" class="w-4 h-4 text-green-600 rounded focus:ring-green-500 border-gray-300 cursor-pointer">
                        <label for="enableTaxOpt" class="text-xs font-medium text-gray-600 select-none">ì–‘ë„ì„¸ ìµœì í™” (22% ì´ˆê³¼ ì¬ì…ê¸ˆ)</label>
                    </div>

                    <div class="space-y-1"> <!-- space-y-1ë¡œ ê°„ê²© ìµœì†Œí™” -->
                        
                        <!-- ì¸ì¶œ ì‹œì‘ì¼ / ìµœëŒ€ ì¸ì¶œì¼ (2ì—´ ê·¸ë¦¬ë“œ, gap-1ë¡œ ì¶•ì†Œ) -->
                        <div class="grid grid-cols-2 gap-1 text-xs"> 
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-0.5">ì¸ì¶œ ì‹œì‘ì¼</label>
                                <input type="date" id="withdrawStartDate" value="2024-01-02" class="w-full border border-gray-300 rounded px-2 py-0.5 text-xs focus:ring-2 focus:ring-indigo-200 outline-none disabled:bg-gray-100 disabled:text-gray-400 disabled:cursor-not-allowed">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-0.5">ìµœëŒ€ ì¸ì¶œì¼</label>
                                <input type="date" id="withdrawEndDate" value="2025-12-03" class="w-full border border-gray-300 rounded px-2 py-0.5 text-xs focus:ring-2 focus:ring-indigo-200 outline-none disabled:bg-gray-100 disabled:text-gray-400 disabled:cursor-not-allowed">
                            </div>
                        </div>

                        <!-- ì¦ê°í•¨ìˆ˜ì§€ìˆ˜ (ë¶„ë¦¬ëœ í–‰, êµ¬ë¶„ì„  ì—†ìŒ) -->
                        <div class="text-xs"> 
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-0.5">ì¦ê°í•¨ìˆ˜ì§€ìˆ˜</label>
                                <input type="number" id="withdrawExponent" value="2.0" step="0.01" class="w-full border border-gray-300 rounded px-2 py-0.5 text-right text-xs focus:ring-2 focus:ring-indigo-200 outline-none">
                            </div>
                        </div>
                        
                        <!-- ì¸ì¶œë¥  ì‹œì‘/ìµœëŒ€ ì„¤ì • (ìœ„ì•„ë˜ ë¶„ë¦¬, ì •ìˆ˜ ì…ë ¥, íŒ¨ë”© ì—†ìŒ) -->
                        <div class="space-y-1 pt-0.5">
                            <!-- ì‹œì‘ ì¸ì¶œë¥  -->
                            <div class="flex justify-between items-center text-xs">
                                <label class="text-xs font-bold text-gray-600">ì‹œì‘ ì¸ì¶œë¥  (%)</label>
                                <div class="flex items-center">
                                    <!-- ì •ìˆ˜ ì…ë ¥ step=1 -->
                                    <input type="number" id="withdrawStartRate" value="0" step="1" class="w-12 border border-gray-300 rounded px-1 py-0.5 text-right text-xs font-bold text-gray-700 outline-none">
                                    <span class="text-gray-500 text-[10px] ml-1">%</span>
                                </div>
                            </div>
                            <!-- ìµœëŒ€ ì¸ì¶œë¥  -->
                            <div class="flex justify-between items-center text-xs">
                                <label class="text-xs font-bold text-gray-600">ìµœëŒ€ ì¸ì¶œë¥  (%)</label>
                                <div class="flex items-center">
                                    <!-- ì •ìˆ˜ ì…ë ¥ step=1 -->
                                    <input type="number" id="withdrawMaxRate" value="50" step="1" class="w-12 border border-gray-300 rounded px-1 py-0.5 text-right text-xs font-bold text-gray-700 outline-none">
                                    <span class="text-gray-500 text-[10px] ml-1">%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- ì‹¤í–‰ ë²„íŠ¼ -->
            <div class="text-center mb-10">
                <button onclick="runBacktest()" class="w-full md:w-1/2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-200 text-lg transform hover:-translate-y-0.5">
                    ğŸš€ ì„¤ì •ê°’ìœ¼ë¡œ ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰
                </button>
            </div>

            <!-- ê²°ê³¼ ì˜ì—­ -->
            <div id="resultArea" class="hidden animate-fade-in">
                <!-- ìš”ì•½ ì§€í‘œ (ìŠ¹ë¥ , ì†ìµë¹„ ì¶”ê°€) -->
                <div class="grid grid-cols-2 md:grid-cols-5 lg:grid-cols-9 gap-4 mb-6">
                    <div class="bg-white p-3 rounded shadow text-center border-t-4 border-indigo-500">
                        <p class="text-xs text-gray-500 font-bold uppercase">ìµœì¢… ìì‚°</p>
                        <p id="resFinalValue" class="text-lg font-extrabold text-indigo-700 mt-2">-</p>
                    </div>
                    <div class="bg-white p-3 rounded shadow text-center border-t-4 border-gray-400">
                        <p class="text-xs text-gray-500 font-bold uppercase">ëˆ„ì  ìˆ˜ìµë¥ </p>
                        <p id="resTotalReturn" class="text-lg font-extrabold mt-2">-</p>
                    </div>
                    <div class="bg-white p-3 rounded shadow text-center border-t-4 border-green-500">
                        <p class="text-xs text-gray-500 font-bold uppercase">CAGR</p>
                        <p id="resCagr" class="text-lg font-extrabold text-green-600 mt-2">-</p>
                    </div>
                    <div class="bg-white p-3 rounded shadow text-center border-t-4 border-red-500">
                        <p class="text-xs text-gray-500 font-bold uppercase">MDD</p>
                        <p id="resMdd" class="text-lg font-extrabold text-red-600 mt-2">-</p>
                    </div>
                    <div class="bg-white p-3 rounded shadow text-center border-t-4 border-orange-400">
                        <p class="text-xs text-gray-500 font-bold uppercase">Pain Index</p>
                        <p id="resPain" class="text-lg font-extrabold text-orange-500 mt-2">-</p>
                    </div>
                    <div class="bg-white p-3 rounded shadow text-center border-t-4 border-purple-500">
                        <p class="text-xs text-gray-500 font-bold uppercase">GPR</p>
                        <p id="resGpr" class="text-lg font-extrabold text-purple-600 mt-2">-</p>
                    </div>
                    <div class="bg-white p-3 rounded shadow text-center border-t-4 border-pink-500">
                        <p class="text-xs text-gray-500 font-bold uppercase">Calmar Ratio</p>
                        <p id="resCalmar" class="text-lg font-extrabold text-pink-600 mt-2">-</p>
                    </div>
                    <!-- ìŠ¹ë¥  -->
                    <div class="bg-white p-3 rounded shadow text-center border-t-4 border-blue-500">
                        <p class="text-xs text-gray-500 font-bold uppercase">ìŠ¹ë¥ </p>
                        <p id="resWinRate" class="text-lg font-extrabold text-blue-600 mt-2">-</p>
                    </div>
                    <!-- ì†ìµë¹„ -->
                    <div class="bg-white p-3 rounded shadow text-center border-t-4 border-teal-500">
                        <p class="text-xs text-gray-500 font-bold uppercase">ì†ìµë¹„</p>
                        <p id="resProfitFactor" class="text-lg font-extrabold text-teal-600 mt-2">-</p>
                    </div>
                </div>
                
                <!-- ì—°ë„ë³„ ì„±ê³¼ ë¶„ì„ í…Œì´ë¸” -->
                <div id="annualMetricsArea" class="bg-white p-4 rounded-lg shadow mb-6 border border-gray-200">
                    <h3 class="font-bold text-lg mb-3 px-2 text-gray-700">ğŸ—“ï¸ ì—°ë„ë³„ ì„±ê³¼ ë¶„ì„</h3>
                    <table class="min-w-full text-xs text-right border-collapse">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600 uppercase border-b">
                                <th class="py-2 px-3 text-center">ì—°ë„</th>
                                <th class="py-2 px-2 text-right">ì‹œì‘ ìì‚° ($)</th>
                                <th class="py-2 px-2 text-right">ì¢…ë£Œ ìì‚° ($)</th>
                                <th class="py-2 px-2 text-right">ìˆ˜ìµë¥  (%)</th>
                                <th class="py-2 px-2 text-right">MDD (%)</th>
                                <th class="py-2 px-2 text-right">ì‹¤í˜„ìˆ˜ìµ ($)</th>
                                <th class="py-2 px-2 text-right">ì—°ë„ë³„ ì¸ì¶œì•¡ ($)</th>
                                <th class="py-2 px-2 text-right">ì¸ì¶œ/ìˆ˜ìµ ë¹„ìœ¨ (%)</th>
                            </tr>
                        </thead>
                        <tbody id="annualMetricsTableBody" class="text-gray-700 divide-y">
                            <!-- JSë¡œ ì±„ì›Œì§ -->
                        </tbody>
                    </table>
                </div>

                <!-- ì°¨íŠ¸ ì˜ì—­ -->
                <div class="bg-white p-4 rounded-lg shadow mb-6 border border-gray-200" id="chartContainer">
                    <h3 class="font-bold text-lg mb-2 px-2 text-gray-700">ğŸ“ˆ ìì‚° ë° ì£¼ê°€ ì¶”ì´</h3>
                    <div class="relative h-[400px]">
                        <canvas id="strategyChart"></canvas>
                    </div>
                </div>

                <!-- ë°˜ì˜ë¥  ë³€ë™ ì¶”ì´ ì°¨íŠ¸ -->
                <div class="bg-white p-4 rounded-lg shadow mb-6 border border-gray-200" id="rateChartContainer">
                    <h3 class="font-bold text-lg mb-2 px-2 text-gray-700">ğŸ“Š ë°˜ì˜ë¥  ë³€ë™ ì¶”ì´ (Rates)</h3>
                    <div class="relative h-[300px]">
                        <canvas id="rateChart"></canvas>
                    </div>
                </div>

                <!-- ìƒì„¸ ë‚´ì—­ í…Œì´ë¸” -->
                <div class="bg-white p-4 rounded-lg shadow overflow-x-auto" id="tableContainer">
                    <h3 class="font-bold text-lg mb-3 px-2 text-gray-700">ğŸ“„ ì¼ë³„ ìƒì„¸ ê±°ë˜ ë‚´ì—­ (ì „ì²´)</h3>
                    <table class="min-w-full text-xs text-right border-collapse">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600 uppercase border-b">
                                <th class="py-3 px-3 text-center sticky left-0 bg-gray-100 border-r z-10">ë‚ ì§œ</th>
                                <th class="py-3 px-2 text-right">ì¢…ê°€</th>
                                <th class="py-3 px-2 text-right">ë“±ë½</th>
                                <th class="py-3 px-2 text-center">ëª¨ë“œ</th>
                                <th class="py-3 px-2 text-right">íˆ¬ìê¸ˆ</th>
                                <th class="py-3 px-2 text-right">ë§¤ìˆ˜ì—¬ë ¥</th>
                                <th class="py-3 px-2 text-center text-blue-600 font-bold">ë§¤ìˆ˜ëŸ‰</th>
                                <th class="py-3 px-2 text-center">í¬íŠ¸</th>
                                <!-- ëª©í‘œê°€ -> ë§¤ë„ëª©í‘œê°€ë¡œ ë³€ê²½ -->
                                <th class="py-3 px-2 bg-blue-50 text-blue-700">ë§¤ë„ëª©í‘œê°€</th>
                                <th class="py-3 px-2 text-center bg-red-50 text-red-700">ë§¤ë„ì¼</th>
                                <th class="py-3 px-2 text-center text-indigo-700 font-bold">ì¸ì¶œê¸ˆ</th>
                                <th class="py-3 px-2 font-bold">í‰ê°€ì•¡</th>
                                <th class="py-3 px-2 text-gray-400">ì˜ˆìˆ˜ê¸ˆ</th>
                                <th class="py-3 px-2">ì‹¤í˜„ìˆ˜ìµ</th>
                                <th class="py-3 px-2 text-gray-400">ë³´ìœ </th>
                                <th class="py-3 px-2 text-right text-gray-500 border-l">DD</th> <!-- DD ì»¬ëŸ¼ ì¶”ê°€ -->
                            </tr>
                        </thead>
                        <tbody id="logTableBody" class="text-gray-700 divide-y">
                            <!-- JSë¡œ ì¶”ê°€ë¨ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ==================== TAB 2: íŒŒë¼ë¯¸í„° ìµœì í™” ==================== -->
        <div id="tabContentOptimization" class="hidden">
            <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-indigo-600 mb-6">
                <h2 class="font-bold text-xl mb-4 text-indigo-800 flex items-center gap-2">
                    âš¡ íŒŒë¼ë¯¸í„° ìµœì í™” (Random Search)
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- í…ŒìŠ¤íŠ¸ ë²”ìœ„ ì„¤ì • (ì™¼ìª½) -->
                    <div class="space-y-4">
                        <h3 class="font-bold text-md text-gray-700 border-b pb-2">1. í…ŒìŠ¤íŠ¸ ë²”ìœ„ ì„¤ì • (Min ~ Max)</h3>
                        
                        <!-- ì•ˆì „ ëª¨ë“œ ë²”ìœ„ -->
                        <div class="bg-blue-50 p-3 rounded border border-blue-100">
                            <h4 class="text-xs font-bold text-blue-700 mb-2">ì•ˆì „ ëª¨ë“œ (SF)</h4>
                            <div class="grid grid-cols-3 gap-2 text-xs">
                                <div class="font-bold text-gray-500 self-center">ë§¤ìˆ˜(Loc) <span class="text-[10px] text-gray-400 font-normal">Step 0.1</span></div>
                                <input type="number" id="optSfLocMin" value="0.1" step="0.1" class="border rounded px-1 text-center" placeholder="Min">
                                <input type="number" id="optSfLocMax" value="7.0" step="0.1" class="border rounded px-1 text-center" placeholder="Max">
                                
                                <div class="font-bold text-gray-500 self-center">ë§¤ë„(Profit) <span class="text-[10px] text-gray-400 font-normal">Step 0.1</span></div>
                                <input type="number" id="optSfProfitMin" value="0.1" step="0.1" class="border rounded px-1 text-center" placeholder="Min">
                                <input type="number" id="optSfProfitMax" value="4.0" step="0.1" class="border rounded px-1 text-center" placeholder="Max">
                                
                                <div class="font-bold text-gray-500 self-center">ë¶„í• (Split) <span class="text-[10px] text-gray-400 font-normal">Step 1</span></div>
                                <input type="number" id="optSfSplitMin" value="6" step="1" class="border rounded px-1 text-center" placeholder="Min">
                                <input type="number" id="optSfSplitMax" value="10" step="1" class="border rounded px-1 text-center" placeholder="Max">

                                <div class="font-bold text-gray-500 self-center">ë³´ìœ (Hold) <span class="text-[10px] text-gray-400 font-normal">Step 5</span></div>
                                <input type="number" id="optSfHoldMin" value="30" step="5" class="border rounded px-1 text-center" placeholder="Min">
                                <input type="number" id="optSfHoldMax" value="40" step="5" class="border rounded px-1 text-center" placeholder="Max">
                            </div>
                        </div>

                        <!-- ê³µì„¸ ëª¨ë“œ ë²”ìœ„ -->
                        <div class="bg-red-50 p-3 rounded border border-red-100">
                            <h4 class="text-xs font-bold text-red-700 mb-2">ê³µì„¸ ëª¨ë“œ (AG)</h4>
                            <div class="grid grid-cols-3 gap-2 text-xs">
                                <div class="font-bold text-gray-500 self-center">ë§¤ìˆ˜(Loc) <span class="text-[10px] text-gray-400 font-normal">Step 0.1</span></div>
                                <input type="number" id="optAgLocMin" value="2.0" step="0.1" class="border rounded px-1 text-center" placeholder="Min">
                                <input type="number" id="optAgLocMax" value="5.0" step="0.1" class="border rounded px-1 text-center" placeholder="Max">
                                
                                <div class="font-bold text-gray-500 self-center">ë§¤ë„(Profit) <span class="text-[10px] text-gray-400 font-normal">Step 0.1</span></div>
                                <input type="number" id="optAgProfitMin" value="1.0" step="0.1" class="border rounded px-1 text-center" placeholder="Min">
                                <input type="number" id="optAgProfitMax" value="7.0" step="0.1" class="border rounded px-1 text-center" placeholder="Max">
                                
                                <div class="font-bold text-gray-500 self-center">ë¶„í• (Split) <span class="text-[10px] text-gray-400 font-normal">Step 1</span></div>
                                <input type="number" id="optAgSplitMin" value="6" step="1" class="border rounded px-1 text-center" placeholder="Min">
                                <input type="number" id="optAgSplitMax" value="10" step="1" class="border rounded px-1 text-center" placeholder="Max">

                                <div class="font-bold text-gray-500 self-center">ë³´ìœ (Hold) <span class="text-[10px] text-gray-400 font-normal">Step 1</span></div>
                                <input type="number" id="optAgHoldMin" value="6" step="1" class="border rounded px-1 text-center" placeholder="Min">
                                <input type="number" id="optAgHoldMax" value="9" step="1" class="border rounded px-1 text-center" placeholder="Max">
                            </div>
                        </div>

                        <!-- ë³µë¦¬ë°˜ì˜ë¥  ë²”ìœ„ (ëª…ì¹­ ë³€ê²½) -->
                        <div class="bg-purple-50 p-3 rounded border border-purple-100">
                            <h4 class="text-xs font-bold text-purple-700 mb-2">ë³µë¦¬ë°˜ì˜ë¥  (Rate)</h4>
                            <div class="grid grid-cols-3 gap-2 text-xs">
                                <div class="font-bold text-gray-500 self-center">ìˆ˜ìµë°˜ì˜(%) <span class="text-[10px] text-gray-400 font-normal">Step 5</span></div>
                                <input type="number" id="optReinvestMin" value="60" step="5" class="border rounded px-1 text-center" placeholder="Min">
                                <input type="number" id="optReinvestMax" value="100" step="5" class="border rounded px-1 text-center" placeholder="Max">
                                
                                <div class="font-bold text-gray-500 self-center">ì†ì‹¤ë°˜ì˜(%) <span class="text-[10px] text-gray-400 font-normal">Step 5</span></div>
                                <input type="number" id="optLossMin" value="20" step="5" class="border rounded px-1 text-center" placeholder="Min">
                                <input type="number" id="optLossMax" value="100" step="5" class="border rounded px-1 text-center" placeholder="Max">
                            </div>
                        </div>
                    </div>

                    <!-- ì‹œë®¬ë ˆì´ì…˜ ì„¤ì • (ì˜¤ë¥¸ìª½) -->
                    <div class="space-y-4">
                        <h3 class="font-bold text-md text-gray-700 border-b pb-2">2. ì‹œë®¬ë ˆì´ì…˜ ì„¤ì •</h3>

                        <!-- NEW: ì¸ì¶œ ì „ëµ ì˜µì…˜ ì¶”ê°€ (ìµœì í™” íƒ­ìš©) -->
                        <div class="bg-indigo-50 p-2 rounded border border-indigo-100 mb-2">
                            <h4 class="text-xs font-bold text-indigo-700 mb-2">ì¸ì¶œ ì „ëµ ì˜µì…˜</h4>
                            <div class="flex flex-col gap-1">
                                <div class="flex items-center gap-2">
                                    <input type="checkbox" id="optEnableAnnualWithdrawal" class="w-3 h-3 text-pink-600 rounded focus:ring-pink-500 border-gray-300 cursor-pointer">
                                    <label for="optEnableAnnualWithdrawal" class="text-xs text-gray-700 cursor-pointer select-none">ì–‘ë„ì„¸ ì¸ì¶œì „ëµ ì‚¬ìš©</label>
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="checkbox" id="optEnableTaxOpt" class="w-3 h-3 text-green-600 rounded focus:ring-green-500 border-gray-300 cursor-pointer">
                                    <label for="optEnableTaxOpt" class="text-xs text-gray-700 cursor-pointer select-none">ì–‘ë„ì„¸ ìµœì í™” (22% ì´ˆê³¼ ì¬ì…ê¸ˆ)</label>
                                </div>
                            </div>
                            <p class="text-[10px] text-gray-400 mt-1">* ìƒì„¸ ìˆ˜ì¹˜(ì¦ê°í•¨ìˆ˜,ì‹œì‘ì¸ì¶œë¥ ,ìµœëŒ€ì¸ì¶œë¥ )ì€ 'ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰' íƒ­ì˜ ì„¤ì •ì„ ë”°ë¦…ë‹ˆë‹¤.</p>
                        </div>
                        
                        <!-- ìµœì í™” ê¸°ê°„ ì„¤ì • -->
                        <div class="grid grid-cols-2 gap-3 mb-2">
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">ì‹œì‘ì¼</label>
                                <input type="date" id="optStartDate" value="2014-01-01" class="w-full border border-gray-300 rounded px-2 py-1 text-xs outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">ì¢…ë£Œì¼</label>
                                <input type="date" id="optEndDate" value="" class="w-full border border-gray-300 rounded px-2 py-1 text-xs outline-none">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-600 mb-1">í…ŒìŠ¤íŠ¸ ë°˜ë³µ íšŸìˆ˜ (Default: 5000)</label>
                            <input type="number" id="optSampleCount" value="5000" class="w-full border border-gray-300 rounded px-3 py-2">
                            <p class="text-xs text-gray-400 mt-1">* íšŸìˆ˜ê°€ ë§ì„ìˆ˜ë¡ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦½ë‹ˆë‹¤.</p>
                        </div>
                        
                        <!-- ê²°ê³¼ í•„í„°ë§ (Limit) (ì¢Œìš° ë°°ì¹˜) -->
                        <div class="bg-gray-50 p-2 rounded border border-gray-200 mt-2">
                            <h4 class="text-xs font-bold text-gray-700 mb-2">3. ê²°ê³¼ í•„í„°ë§ (Limit)</h4>
                            <div class="grid grid-cols-2 gap-x-3 gap-y-2 text-xs">
                                <div class="flex justify-between items-center">
                                    <label class="text-gray-500 font-medium">CAGR(Min)</label>
                                    <input type="number" id="optMinCagr" value="70" class="w-14 border rounded px-1 text-right bg-white outline-none">
                                </div>
                                <div class="flex justify-between items-center">
                                    <label class="text-gray-500 font-medium">MDD(Max)</label>
                                    <input type="number" id="optMaxMdd" value="50" class="w-14 border rounded px-1 text-right bg-white outline-none">
                                </div>
                                <div class="flex justify-between items-center">
                                    <label class="text-gray-500 font-medium">Pain(Max)</label>
                                    <input type="number" id="optMaxPain" value="9" class="w-14 border rounded px-1 text-right bg-white outline-none">
                                </div>
                                <div class="flex justify-between items-center">
                                    <label class="text-gray-500 font-medium">Calmar(Min)</label>
                                    <input type="number" id="optMinCalmar" value="1.2" step="0.1" class="w-14 border rounded px-1 text-right bg-white outline-none">
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-600 mb-1 mt-3">ìš°ì„ ìˆœìœ„ (ì •ë ¬ ê¸°ì¤€)</label>
                            <select id="optSortBy" onchange="sortAndDisplayOptimizationResults()" class="w-full border border-gray-300 rounded px-3 py-2 bg-white">
                                <option value="CAGR">CAGR (ë†’ì€ìˆœ)</option>
                                <option value="TotalReturn">ëˆ„ì  ìˆ˜ìµë¥  (ë†’ì€ìˆœ)</option>
                                <option value="MDD">MDD (ë‚®ì€ìˆœ)</option>
                                <option value="Pain">Pain Index (ë‚®ì€ìˆœ)</option>
                                <option value="Calmar">Calmar Ratio (ë†’ì€ìˆœ)</option>
                            </select>
                        </div>

                        <button onclick="runOptimization()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition mt-6">
                            âš¡ ìµœì í™” ì‹œì‘
                        </button>
                        
                        <div id="optProgress" class="hidden text-center text-sm font-bold text-indigo-600 mt-2 animate-pulse">
                            ì‹œë®¬ë ˆì´ì…˜ ì§„í–‰ ì¤‘...
                        </div>
                    </div>
                </div>

                <!-- ìµœì í™” ê²°ê³¼ í…Œì´ë¸” -->
                <div id="optResultArea" class="hidden">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-lg text-gray-700">ğŸ† ìµœì í™” ê²°ê³¼ (Top 10)</h3>
                        <span id="optStatsText" class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-1 rounded"></span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-xs text-right border-collapse bg-white shadow-sm rounded-lg overflow-hidden">
                            <thead class="bg-indigo-50 text-indigo-800 uppercase font-bold">
                                <tr>
                                    <th class="py-3 px-2 text-center">ìˆœìœ„</th>
                                    <th class="py-3 px-2">CAGR</th>
                                    <th class="py-3 px-2">MDD</th>
                                    <th class="py-3 px-2">Pain Index</th>
                                    <th class="py-3 px-2">ëˆ„ì ìˆ˜ìµë¥ </th>
                                    <th class="py-3 px-2 bg-blue-50">SF ë§¤ìˆ˜</th>
                                    <th class="py-3 px-2 bg-blue-50">SF ë§¤ë„</th>
                                    <th class="py-3 px-2 bg-blue-50">SF ë¶„í• </th>
                                    <th class="py-3 px-2 bg-blue-50">SF ë³´ìœ </th>
                                    <th class="py-3 px-2 bg-red-50">AG ë§¤ìˆ˜</th>
                                    <th class="py-3 px-2 bg-red-50">AG ë§¤ë„</th>
                                    <th class="py-3 px-2 bg-red-50">AG ë¶„í• </th>
                                    <th class="py-3 px-2 bg-red-50">AG ë³´ìœ </th>
                                    <th class="py-3 px-2 bg-purple-50">ìˆ˜ìµë°˜ì˜ë¥ </th>
                                    <th class="py-3 px-2 bg-purple-50">ì†ì‹¤ë°˜ì˜ë¥ </th>
                                    <th class="py-3 px-2 text-center">ì ìš©</th>
                                </tr>
                            </thead>
                            <tbody id="optTableBody" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <!-- ìŠ¤í¬ë¦½íŠ¸ ì˜ì—­ -->
    <script>
        // --- ì „ì—­ ë³€ìˆ˜ (ìµœì í™” ê²°ê³¼ ì €ì¥ìš©) ---
        let optimizationResults = [];

        // --- íƒ­ ì „í™˜ ë¡œì§ ---
        function switchTab(tabId) {
            const backtestContent = document.getElementById('tabContentBacktest');
            const optContent = document.getElementById('tabContentOptimization');
            const btnBacktest = document.getElementById('tabBtnBacktest');
            const btnOpt = document.getElementById('tabBtnOptimization');

            if (tabId === 'backtest') {
                backtestContent.classList.remove('hidden');
                optContent.classList.add('hidden');
                btnBacktest.className = 'flex-1 py-3 text-center text-sm tab-active transition-colors';
                btnOpt.className = 'flex-1 py-3 text-center text-sm tab-inactive transition-colors';
            } else {
                backtestContent.classList.add('hidden');
                optContent.classList.remove('hidden');
                btnBacktest.className = 'flex-1 py-3 text-center text-sm tab-inactive transition-colors';
                btnOpt.className = 'flex-1 py-3 text-center text-sm tab-active transition-colors';
            }
        }

        // --- ìƒí˜¸ ë°°ì œ ì²´í¬ë°•ìŠ¤ ë¡œì§ ---
        function toggleWithdrawalCheckboxes(mode) {
            const annualCheckbox = document.getElementById('enableAnnualWithdrawal');
            const periodCheckbox = document.getElementById('enableWithdrawal');
            const taxOptCheckbox = document.getElementById('enableTaxOpt');
            const startDateInput = document.getElementById('withdrawStartDate');
            const endDateInput = document.getElementById('withdrawEndDate');

            if (mode === 'annual') {
                if (annualCheckbox.checked) {
                    periodCheckbox.checked = false;
                    startDateInput.disabled = true;
                    endDateInput.disabled = true;
                } else {
                    startDateInput.disabled = false;
                    endDateInput.disabled = false;
                    taxOptCheckbox.checked = false;
                }
            } else if (mode === 'period') {
                if (periodCheckbox.checked) {
                    annualCheckbox.checked = false;
                    taxOptCheckbox.checked = false;
                    startDateInput.disabled = false;
                    endDateInput.disabled = false;
                } else {
                    if (!annualCheckbox.checked) {
                        startDateInput.disabled = false;
                        endDateInput.disabled = false;
                    }
                }
            }
        }

        // --- ìƒìˆ˜ ë° ì „ì—­ ë³€ìˆ˜ ---
        const SHEET_ID = '1CY8hVPAXfPZZOfBgTaU5ygeLg4OXR14So_6dhfyoJjs';
        const SHEET_NAME = 'DBALL';
        const SEC_FEE_RATE = 0.0000278;
        const DECIMAL_4_START = new Date('2011-01-03');
        const DECIMAL_4_END = new Date('2021-03-01');
        
        let rawPriceData = [];
        let rawModeData = [];
        let chartInstance = null;
        let rateChartInstance = null;

        window.addEventListener('load', function() {
            // Set default dates
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayStr = `${year}-${month}-${day}`;
            
            const endDateEl = document.getElementById('endDate');
            const optEndDateEl = document.getElementById('optEndDate');
            
            if(endDateEl) endDateEl.value = todayStr;
            if(optEndDateEl) optEndDateEl.value = todayStr;

            loadFromGoogleSheet();
        });

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        function floorVal(val, decimals) {
            const factor = Math.pow(10, decimals);
            return Math.floor(val * factor) / factor;
        }
        function roundVal(val, decimals) {
            const factor = Math.pow(10, decimals);
            return Math.round(val * factor) / factor;
        }
        function parseDate(dateStr) {
            if (!dateStr) return null;
            let s = String(dateStr).trim();
            s = s.replace(/\s*\(.*\)\s*$/, '').replace(/\.$/, '').replace(/[\s,]/g, '').replace(/\u200B/g, '');
            s = s.replace(/[\.\/]/g, '-');
            const parts = s.split('-');
            if (parts.length === 3) {
                if (parts[0].length === 2) parts[0] = '20' + parts[0];
            } else { return null; }
            const date = new Date(parts.join('-'));
            return isNaN(date.getTime()) ? null : date;
        }
        function formatNum(num, fixed=2) {
            return num.toLocaleString(undefined, {minimumFractionDigits: fixed, maximumFractionDigits: fixed});
        }
        // --- NEW: ëœë¤ í•¨ìˆ˜ (ìµœì í™”ìš©) ---
        function getRandom(min, max) { 
             return parseFloat((Math.random() * (max - min) + min).toFixed(1));
        }
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        // NEW: Step ë‹¨ìœ„ ëœë¤ í•¨ìˆ˜ (ì •í™•í•œ Step ì ìš©)
        function getRandomStep(min, max, step) {
            if (step <= 0) return min;
            const count = Math.floor((max - min) / step);
            const randomIdx = Math.floor(Math.random() * (count + 1));
            const val = min + (randomIdx * step);
            return parseFloat(val.toFixed(2)); 
        }

        // --- ë°ì´í„° ë¡œë“œ ---
        async function loadFromGoogleSheet() {
            const badge = document.getElementById('dbStatusBadge');
            const manualLink = document.getElementById('manualDownloadLink');
            
            badge.className = "flex items-center gap-2 text-sm font-bold text-indigo-600 animate-pulse bg-white px-3 py-1 rounded-full shadow-sm";
            badge.innerHTML = `<svg class="animate-spin h-4 w-4 text-indigo-500" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ë°ì´í„° ë¡œë”© ì¤‘...`;
            if (manualLink) manualLink.classList.add('hidden');

            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0&t=${Date.now()}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("Network response was not ok");
                const csvText = await response.text();
                Papa.parse(csvText, {
                    complete: function(results) { processCSV(results.data); },
                    error: function(err) { throw err; }
                });
            } catch (error) {
                console.error("Data Load Error:", error);
                badge.className = "flex items-center gap-2 text-sm font-bold text-red-600 bg-white px-3 py-1 rounded-full shadow-sm cursor-pointer";
                badge.innerHTML = `âš ï¸ ë¡œë“œ ì‹¤íŒ¨ (ì—¬ê¸°ë¥¼ ëˆŒëŸ¬ ì¬ì‹œë„)`;
                badge.onclick = loadFromGoogleSheet;
                if (manualLink) manualLink.classList.remove('hidden');
            }
        }

        // CSV Upload Handler
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            Papa.parse(file, {
                complete: function(results) { processCSV(results.data); }
            });
        });

        function processCSV(data) {
            rawPriceData = [];
            rawModeData = [];
            const targetDateStr = '2025-08-15';
            let foundTargetDate = false;

            for (let i = 132; i < data.length; i++) {
                const row = data[i];
                if (!row[0] || !row[1]) continue;
                const date = parseDate(row[0]);
                const priceStr = String(row[1]).replace(/,/g, '');
                const price = parseFloat(priceStr);
                if (date && !isNaN(price)) {
                    rawPriceData.push({ date: date, close: price });
                    if (date.toISOString().slice(0, 10) === targetDateStr) foundTargetDate = true;
                }
            }
            for (let i = 3; i < data.length; i++) {
                const row = data[i];
                if (!row[4] || !row[7]) continue; 
                const date = parseDate(row[4]);
                const mode = row[7].trim();
                if (date && mode) rawModeData.push({ date: date, mode: mode });
            }
            rawPriceData.sort((a, b) => a.date - b.date);
            rawModeData.sort((a, b) => a.date - b.date);

            const badge = document.getElementById('dbStatusBadge');
            const manualLink = document.getElementById('manualDownloadLink');
            
            if (rawPriceData.length > 0) {
                const startY = rawPriceData[0].date.getFullYear();
                const endY = rawPriceData[rawPriceData.length-1].date.getFullYear();
                badge.className = "flex items-center gap-2 text-sm font-bold text-green-600 bg-white px-3 py-1 rounded-full shadow-sm";
                badge.innerHTML = `ğŸŸ¢ ë°ì´í„° ì¤€ë¹„ë¨ (${startY}~${endY})`;
                badge.onclick = null;
                if (manualLink) manualLink.classList.add('hidden');
            } else {
                badge.className = "flex items-center gap-2 text-sm font-bold text-yellow-600 bg-white px-3 py-1 rounded-full shadow-sm";
                badge.innerHTML = `âš ï¸ ë°ì´í„° ì—†ìŒ (í˜•ì‹ í™•ì¸ í•„ìš”)`;
            }
        }

        // --- Core Simulation Logic ---
        function executeSimulation(params, priceData, modeData) {
            const { 
                initialCapital, brokerFee, useSecFee, startDate, endDate,
                sfLoc, sfProfit, sfSplit, sfHold,
                agLoc, agProfit, agSplit, agHold,
                capitalCycle, reinvestRate, lossRate,
                withdrawalSettings 
            } = params;

            let mergedData = [];
            let currentModeIdx = 0;
            let priceStartIndex = priceData.findIndex(p => p.date >= startDate);
            if (priceStartIndex === -1) return null; 
            let loopStart = priceStartIndex > 0 ? priceStartIndex - 1 : priceStartIndex;

            for (let i = loopStart; i < priceData.length; i++) {
                const p = priceData[i];
                if (p.date > endDate) break;
                while (currentModeIdx < modeData.length - 1 && modeData[currentModeIdx + 1].date <= p.date) {
                    currentModeIdx++;
                }
                let mode = modeData.length > 0 ? modeData[currentModeIdx].mode : 'SF'; 
                if (modeData.length > 0 && p.date < modeData[0].date) mode = modeData[0].mode;
                mergedData.push({ date: p.date, close: p.close, mode: mode });
            }
            if (mergedData.length < 2) return null;

            let investCapital = initialCapital;
            let cash = initialCapital;
            let holdings = []; 
            let history = [];
            let daysSinceUpdate = 0;
            let periodProfit = 0;
            let cumulativeProfit = 0; 
            let cumulativeWithdrawal = 0; 
            let annualRealizedProfit = 0;
            let annualTotalWithdrawal = 0;
            const lastYear = endDate.getFullYear();
            
            // STATS FOR WIN RATE/PROFIT FACTOR
            let tradeCount = 0;
            let winCount = 0;
            let totalGrossProfit = 0;
            let totalGrossLoss = 0;

            const sfRule = { loc: 1 + sfLoc/100, profit: 1 + sfProfit/100, split: sfSplit, hold: sfHold };
            const agRule = { loc: 1 + agLoc/100, profit: 1 + agProfit/100, split: agSplit, hold: agHold };
            const reinvestRateVal = reinvestRate / 100;
            const lossRateVal = lossRate / 100;
            const wStartRate = withdrawalSettings.startRate / 100;
            const wMaxRate = withdrawalSettings.maxRate / 100;

            function getWithdrawRate(currentDate) {
                if (!withdrawalSettings.enabled) return 0;
                let wStart = withdrawalSettings.startDate;
                let wEnd = withdrawalSettings.endDate;

                if (withdrawalSettings.type === 'annual') {
                    const currentYear = currentDate.getFullYear();
                    const startYear = startDate.getFullYear();
                    wStart = new Date(currentYear, 0, 1); 
                    wEnd = new Date(currentYear, 11, 31); 
                    wEnd.setHours(23, 59, 59, 999);
                    if (currentYear === startYear) wStart = startDate;
                    if (currentDate < wStart) return 0;
                } else {
                    if (currentDate < wStart) return 0;
                    if (currentDate >= wEnd) return roundVal(wMaxRate, 4);
                }
                if (currentDate >= wEnd) return roundVal(wMaxRate, 4);
                
                const timeDiff = currentDate.getTime() - wStart.getTime();
                const totalDiff = wEnd.getTime() - wStart.getTime(); 
                if (totalDiff <= 0) return roundVal(wMaxRate, 4);
                
                const progress = timeDiff / totalDiff;
                const scaled = Math.pow(progress, withdrawalSettings.exponent);
                const rate = wStartRate + (wMaxRate - wStartRate) * scaled;
                return roundVal(rate, 4);
            }

            for (let i = 1; i < mergedData.length; i++) {
                const curr = mergedData[i];
                const prev = mergedData[i-1];
                const date = curr.date;
                const close = curr.close;
                const prevClose = prev.close;
                const mode = curr.mode;
                
                let precPrice = 2, precSeed = 0;
                if (date >= DECIMAL_4_START && date <= DECIMAL_4_END) {
                    precPrice = 4; precSeed = 2;
                }
                const precWithdraw = precPrice + 2;
                const startHoldingsCnt = holdings.length;
                daysSinceUpdate++;

                let currentWithdrawRate = 0;
                if (withdrawalSettings.enabled) currentWithdrawRate = getWithdrawRate(date);
                
                let adjReinvest = reinvestRateVal - currentWithdrawRate;
                if(adjReinvest < 0) adjReinvest = 0;
                let redRatio = (reinvestRateVal > 0) ? adjReinvest / reinvestRateVal : 0;
                let adjLoss = lossRateVal * redRatio;

                let effectiveReinvestRate = roundVal(adjReinvest, 4);
                let effectiveLossRate = roundVal(adjLoss, 4);

                let buyingPower = cash;
                let nextHoldings = [];
                let soldToday = false;
                let dailyRealizedProfit = 0;

                for (let h of holdings) {
                    let rule = (h.mode === 'SF' || h.mode === 'ì•ˆì „') ? sfRule : agRule;
                    let targetPrice = roundVal(h.buyPrice * rule.profit, precPrice);
                    let isSold = false;

                    if (h.daysHeld >= (rule.hold - 1)) isSold = true;
                    else if (close >= targetPrice) isSold = true;

                    if (isSold) {
                        let revenue = close * h.qty;
                        let feeBroker = floorVal(revenue * (brokerFee/100), precPrice);
                        let feeSec = 0;
                        if (useSecFee) feeSec = floorVal(revenue * SEC_FEE_RATE, precPrice);
                        let fee = feeBroker + feeSec;
                        let netRev = revenue - fee;
                        let profit = netRev - (h.buyPrice * h.qty) - (h.buyFee || 0); 
                        let roundedProfit = roundVal(profit, precPrice);
                        let roundedNetRev = roundVal(netRev, precPrice);
                        
                        cash = roundVal(cash + roundedNetRev, precPrice); 
                        cumulativeProfit += roundedProfit; 
                        periodProfit += profit; 
                        dailyRealizedProfit += profit;
                        soldToday = true;
                        h.sellDate = date;
                        
                        // Stats Update
                        tradeCount++;
                        if(profit > 0) {
                            winCount++;
                            totalGrossProfit += profit;
                        } else {
                            totalGrossLoss += Math.abs(profit);
                        }
                    } else {
                        h.daysHeld++;
                        nextHoldings.push(h);
                    }
                }
                holdings = nextHoldings;
                if (soldToday) annualRealizedProfit += dailyRealizedProfit;

                let rule = (mode === 'SF' || mode === 'ì•ˆì „') ? sfRule : agRule;
                let splitCnt = rule.split;
                let targetBuyPrice = floorVal(prevClose * rule.loc, precPrice);
                let buyExecutedQty = 0;
                let newPort = null;

                if (startHoldingsCnt < splitCnt) {
                    if (close <= targetBuyPrice) {
                        let onePortCash = floorVal(investCapital / splitCnt, precSeed);
                        if (targetBuyPrice > 0) {
                            let qty = Math.floor(onePortCash / targetBuyPrice);
                            let estAmt = qty * targetBuyPrice;
                            let estFee = floorVal(estAmt * (brokerFee/100), precPrice);
                            if ((estAmt + estFee) > buyingPower) {
                                qty = Math.floor(buyingPower / (targetBuyPrice * (1 + (brokerFee/100))));
                            }
                            if (qty > 0) {
                                let buyAmt = qty * close;
                                let fee = floorVal(buyAmt * (brokerFee/100), precPrice);
                                let totalCost = buyAmt + fee;
                                if (totalCost <= cash) {
                                    cash -= totalCost;
                                    cash = roundVal(cash, precPrice); 
                                    buyExecutedQty = qty;
                                    newPort = {
                                        buyDate: date, buyPrice: close, qty: qty, mode: mode, daysHeld: 0, buyFee: fee, sellDate: null
                                    };
                                    holdings.push(newPort);
                                }
                            }
                        }
                    }
                }

                let currentWithdrawnAmount = 0; 
                if (daysSinceUpdate >= capitalCycle) {
                    const cycleWithdrawRate = getWithdrawRate(date);
                    let cycAdjReinvest = reinvestRateVal - cycleWithdrawRate;
                    if(cycAdjReinvest < 0) cycAdjReinvest = 0;
                    let cycRedRatio = (reinvestRateVal > 0) ? cycAdjReinvest / reinvestRateVal : 0;
                    let cycAdjLoss = lossRateVal * cycRedRatio;

                    if (withdrawalSettings.enabled && periodProfit > 0.00000001) { 
                        currentWithdrawnAmount = roundVal(periodProfit * cycleWithdrawRate, precWithdraw);
                    }
                    
                    let profitToReinvest = periodProfit * (periodProfit > 0 ? cycAdjReinvest : cycAdjLoss);
                    investCapital += profitToReinvest;
                    investCapital = roundVal(investCapital, precSeed);
                    
                    const isLastDayOfBacktest = date.getTime() >= endDate.getTime();
                    if (withdrawalSettings.type !== 'annual' || !isLastDayOfBacktest || date.getFullYear() === endDate.getFullYear()) {
                        cash = roundVal(cash - currentWithdrawnAmount, precPrice);
                    }
                    
                    cumulativeWithdrawal += currentWithdrawnAmount;
                    if (currentWithdrawnAmount > 0) annualTotalWithdrawal += currentWithdrawnAmount;

                    periodProfit = 0;
                    daysSinceUpdate = 0;
                }

                const nextDay = (i < mergedData.length - 1) ? mergedData[i+1] : null;
                const isYearEnd = nextDay ? (date.getFullYear() !== nextDay.date.getFullYear()) : true; 

                if (withdrawalSettings.useTaxOpt && isYearEnd && date.getFullYear() < lastYear) {
                    const taxLimit = annualRealizedProfit * 0.22;
                    if (annualTotalWithdrawal > taxLimit) {
                        const refundAmount = annualTotalWithdrawal - taxLimit;
                        cash += refundAmount;
                        investCapital += refundAmount;
                        cash = roundVal(cash, precPrice);
                        investCapital = roundVal(investCapital, precSeed);
                        cumulativeWithdrawal -= refundAmount;
                        annualTotalWithdrawal -= refundAmount;
                    }
                    annualRealizedProfit = 0;
                    annualTotalWithdrawal = 0;
                } else if (isYearEnd) {
                    annualRealizedProfit = 0;
                    annualTotalWithdrawal = 0;
                }

                let currentSellTargetForDisplay = 0;
                if (buyExecutedQty > 0 && newPort) {
                    let r = (newPort.mode === 'SF' || newPort.mode === 'ì•ˆì „') ? sfRule : agRule;
                    currentSellTargetForDisplay = roundVal(newPort.buyPrice * r.profit, precPrice);
                } 

                let totalQty = holdings.reduce((sum, h) => sum + h.qty, 0); 
                let totalAsset = cash + holdings.reduce((sum, h) => sum + (h.qty * close), 0);

                history.push({
                    date: date, close: close, mode: mode,
                    capital: investCapital, bp: buyingPower,
                    targetBuy: targetBuyPrice, targetSell: currentSellTargetForDisplay,
                    buyQty: buyExecutedQty, newPort: newPort,
                    val: totalAsset, cash: cash, profit: cumulativeProfit,
                    qty: totalQty, cnt: holdings.length, sold: soldToday,
                    withdrawnAmount: currentWithdrawnAmount,
                    cumulativeWithdrawal: cumulativeWithdrawal,
                    effReinvestRate: effectiveReinvestRate * 100, 
                    effLossRate: effectiveLossRate * 100,         
                    withdrawRate: currentWithdrawRate * 100,       
                    dd: 0 
                });
            }

            const last = history[history.length - 1];
            const totalReturn = ((last.val - initialCapital) / initialCapital) * 100;
            const days = (last.date - history[0].date) / (1000 * 60 * 60 * 24);
            const years = days / 365.25;
            const cagr = years > 0 ? (Math.pow(last.val/initialCapital, 1/years) - 1) * 100 : 0;
            
            let maxPeak = -Infinity, mdd = 0, sumDD = 0;
            let dds = [];
            history.forEach(h => {
                if (h.val > maxPeak) maxPeak = h.val;
                let dd = (h.val - maxPeak) / maxPeak;
                if (dd < mdd) mdd = dd;
                sumDD += dd;
                dds.push(dd);
                h.dd = dd * 100;
            });
            mdd *= 100;
            const painIndex = Math.abs(sumDD / history.length) * 100;
            const gpr = painIndex > 0 ? cagr / painIndex : 0;
            const calmar = mdd !== 0 ? cagr / Math.abs(mdd) : 0;
            
            // Win Rate & Profit Factor Calc
            const winRate = tradeCount > 0 ? (winCount / tradeCount) * 100 : 0;
            let profitFactor = 0;
            if (totalGrossLoss === 0) {
                profitFactor = totalGrossProfit > 0 ? 999 : 0; // Infinite if no loss but profit
            } else {
                profitFactor = totalGrossProfit / totalGrossLoss;
            }

            return {
                history: history,
                dds: dds,
                stats: {
                    finalValue: last.val,
                    totalReturn: totalReturn,
                    cagr: cagr,
                    mdd: mdd,
                    painIndex: painIndex,
                    gpr: gpr,
                    calmar: calmar,
                    winRate: winRate,
                    profitFactor: profitFactor
                }
            };
        }

        // --- Main Functions ---

        function runBacktest() {
            const params = {
                initialCapital: parseFloat(document.getElementById('initialCapital').value.replace(/,/g, '')),
                brokerFee: parseFloat(document.getElementById('brokerFee').value),
                useSecFee: document.getElementById('useSecFee').checked,
                startDate: new Date(document.getElementById('startDate').value),
                endDate: (() => {
                    const d = new Date(document.getElementById('endDate').value);
                    d.setHours(23, 59, 59, 999); return d;
                })(),
                sfLoc: parseFloat(document.getElementById('sfLoc').value),
                sfProfit: parseFloat(document.getElementById('sfProfit').value),
                sfSplit: parseInt(document.getElementById('sfSplit').value),
                sfHold: parseInt(document.getElementById('sfHold').value),
                agLoc: parseFloat(document.getElementById('agLoc').value),
                agProfit: parseFloat(document.getElementById('agProfit').value),
                agSplit: parseInt(document.getElementById('agSplit').value),
                agHold: parseInt(document.getElementById('agHold').value),
                capitalCycle: parseInt(document.getElementById('capitalCycle').value),
                reinvestRate: parseFloat(document.getElementById('reinvestRate').value),
                lossRate: parseFloat(document.getElementById('lossRate').value),
                withdrawalSettings: {
                    enabled: document.getElementById('enableWithdrawal').checked || document.getElementById('enableAnnualWithdrawal').checked,
                    type: document.getElementById('enableAnnualWithdrawal').checked ? 'annual' : 'period',
                    startDate: new Date(document.getElementById('withdrawStartDate').value),
                    endDate: new Date(document.getElementById('withdrawEndDate').value),
                    startRate: parseFloat(document.getElementById('withdrawStartRate').value),
                    maxRate: parseFloat(document.getElementById('withdrawMaxRate').value),
                    exponent: parseFloat(document.getElementById('withdrawExponent').value),
                    useTaxOpt: document.getElementById('enableTaxOpt').checked
                }
            };

            const result = executeSimulation(params, rawPriceData, rawModeData);
            if (result) {
                displayResults(result, params.initialCapital);
            }
        }

        function runOptimization() {
            if (rawPriceData.length === 0) { alert("ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); return; }
            
            const sampleCount = parseInt(document.getElementById('optSampleCount').value);
            const sortBy = document.getElementById('optSortBy').value;
            const progressDiv = document.getElementById('optProgress');
            const resultArea = document.getElementById('optResultArea');
            const tbody = document.getElementById('optTableBody');
            
            // Limit Filters
            const minCagr = parseFloat(document.getElementById('optMinCagr').value);
            const maxMdd = parseFloat(document.getElementById('optMaxMdd').value);
            const maxPain = parseFloat(document.getElementById('optMaxPain').value);
            const minCalmar = parseFloat(document.getElementById('optMinCalmar').value);
            
            // NEW: Withdrawal Options for Optimization
            const optEnableAnnual = document.getElementById('optEnableAnnualWithdrawal').checked;
            const optEnableTax = document.getElementById('optEnableTaxOpt').checked;

            progressDiv.classList.remove('hidden');
            resultArea.classList.add('hidden');
            tbody.innerHTML = '';
            document.getElementById('optStatsText').innerText = ''; // Reset stats text

            // Use main tab settings for base params (including fees)
            const baseParams = {
                initialCapital: parseFloat(document.getElementById('initialCapital').value.replace(/,/g, '')),
                // Corrected: Use main tab IDs since optimization tab inputs were removed
                brokerFee: parseFloat(document.getElementById('brokerFee') ? document.getElementById('brokerFee').value : 0.044), 
                useSecFee: document.getElementById('useSecFee') ? document.getElementById('useSecFee').checked : true, 
                startDate: new Date(document.getElementById('optStartDate').value),
                endDate: (() => { const d = new Date(document.getElementById('optEndDate').value); d.setHours(23, 59, 59, 999); return d; })(),
                capitalCycle: parseInt(document.getElementById('capitalCycle').value),
                withdrawalSettings: { 
                    enabled: optEnableAnnual, // Use optimization tab checkbox
                    type: 'annual', // Always 'annual' if enabled in optimization tab context based on user request
                    // Details from Main Tab
                    startDate: new Date(document.getElementById('withdrawStartDate').value),
                    endDate: new Date(document.getElementById('withdrawEndDate').value),
                    startRate: parseFloat(document.getElementById('withdrawStartRate').value),
                    maxRate: parseFloat(document.getElementById('withdrawMaxRate').value),
                    exponent: parseFloat(document.getElementById('withdrawExponent').value),
                    useTaxOpt: optEnableTax // Use optimization tab checkbox
                }
            };

            const ranges = {
                sfLoc: [parseFloat(document.getElementById('optSfLocMin').value), parseFloat(document.getElementById('optSfLocMax').value)],
                sfProfit: [parseFloat(document.getElementById('optSfProfitMin').value), parseFloat(document.getElementById('optSfProfitMax').value)],
                sfSplit: [parseInt(document.getElementById('optSfSplitMin').value), parseInt(document.getElementById('optSfSplitMax').value)],
                sfHold: [parseInt(document.getElementById('optSfHoldMin').value), parseInt(document.getElementById('optSfHoldMax').value)],
                
                agLoc: [parseFloat(document.getElementById('optAgLocMin').value), parseFloat(document.getElementById('optAgLocMax').value)],
                agProfit: [parseFloat(document.getElementById('optAgProfitMin').value), parseFloat(document.getElementById('optAgProfitMax').value)],
                agSplit: [parseInt(document.getElementById('optAgSplitMin').value), parseInt(document.getElementById('optAgSplitMax').value)],
                agHold: [parseInt(document.getElementById('optAgHoldMin').value), parseInt(document.getElementById('optAgHoldMax').value)],
                
                reinvest: [parseFloat(document.getElementById('optReinvestMin').value), parseFloat(document.getElementById('optReinvestMax').value)],
                loss: [parseFloat(document.getElementById('optLossMin').value), parseFloat(document.getElementById('optLossMax').value)],
            };
            
            // Calculate Total Combinations
            const steps = {
                sfLoc: Math.floor((ranges.sfLoc[1] - ranges.sfLoc[0]) / 0.1) + 1,
                sfProfit: Math.floor((ranges.sfProfit[1] - ranges.sfProfit[0]) / 0.1) + 1,
                sfSplit: Math.floor((ranges.sfSplit[1] - ranges.sfSplit[0]) / 1) + 1,
                sfHold: Math.floor((ranges.sfHold[1] - ranges.sfHold[0]) / 5) + 1,
                
                agLoc: Math.floor((ranges.agLoc[1] - ranges.agLoc[0]) / 0.1) + 1,
                agProfit: Math.floor((ranges.agProfit[1] - ranges.agProfit[0]) / 0.1) + 1,
                agSplit: Math.floor((ranges.agSplit[1] - ranges.agSplit[0]) / 1) + 1,
                agHold: Math.floor((ranges.agHold[1] - ranges.agHold[0]) / 1) + 1,
                
                reinvest: Math.floor((ranges.reinvest[1] - ranges.reinvest[0]) / 5) + 1,
                loss: Math.floor((ranges.loss[1] - ranges.loss[0]) / 5) + 1
            };
            
            const totalCombos = steps.sfLoc * steps.sfProfit * steps.sfSplit * steps.sfHold * steps.agLoc * steps.agProfit * steps.agSplit * steps.agHold * steps.reinvest * steps.loss;
                                
            const formattedTotal = totalCombos.toLocaleString();

            setTimeout(() => {
                let results = [];
                let validCount = 0;

                try {
                    for (let i = 0; i < sampleCount; i++) {
                        const currentParams = {
                            ...baseParams,
                            // Randomize ALL params now
                            sfLoc: getRandomStep(ranges.sfLoc[0], ranges.sfLoc[1], 0.1),
                            sfProfit: getRandomStep(ranges.sfProfit[0], ranges.sfProfit[1], 0.1),
                            sfSplit: getRandomStep(ranges.sfSplit[0], ranges.sfSplit[1], 1),
                            sfHold: getRandomStep(ranges.sfHold[0], ranges.sfHold[1], 5),
                            
                            agLoc: getRandomStep(ranges.agLoc[0], ranges.agLoc[1], 0.1),
                            agProfit: getRandomStep(ranges.agProfit[0], ranges.agProfit[1], 0.1),
                            agSplit: getRandomStep(ranges.agSplit[0], ranges.agSplit[1], 1),
                            agHold: getRandomStep(ranges.agHold[0], ranges.agHold[1], 1),
                            
                            reinvestRate: getRandomStep(ranges.reinvest[0], ranges.reinvest[1], 5),
                            lossRate: getRandomStep(ranges.loss[0], ranges.loss[1], 5)
                        };

                        const simResult = executeSimulation(currentParams, rawPriceData, rawModeData);
                        if (simResult) {
                            // Check Filter Limits
                            const s = simResult.stats;
                            // MDD is negative (e.g. -20). Max MDD limit 50 means we accept down to -50.
                            // So mdd (-20) >= -50. Or abs(mdd) <= 50.
                            const passCagr = s.cagr >= minCagr;
                            const passMdd = Math.abs(s.mdd) <= maxMdd;
                            const passPain = s.painIndex <= maxPain;
                            const passCalmar = s.calmar >= minCalmar;

                            if (passCagr && passMdd && passPain && passCalmar) {
                                validCount++;
                                results.push({
                                    params: currentParams,
                                    stats: s
                                });
                            }
                        }
                    }

                    results.sort((a, b) => {
                        if (sortBy === 'CAGR') return b.stats.cagr - a.stats.cagr;
                        if (sortBy === 'TotalReturn') return b.stats.totalReturn - a.stats.totalReturn;
                        if (sortBy === 'MDD') return b.stats.mdd - a.stats.mdd; // Higher (closer to 0) is better for negative MDD
                        if (sortBy === 'Pain') return a.stats.painIndex - b.stats.painIndex; // Lower is better
                        if (sortBy === 'Calmar') return b.stats.calmar - a.stats.calmar;
                        return 0;
                    });

                    // Update Stats Text
                    document.getElementById('optStatsText').innerText = `ì´ ì¡°í•©: ${formattedTotal}ê°œ / í…ŒìŠ¤íŠ¸: ${sampleCount}íšŒ (ì¡°ê±´ë§Œì¡±: ${validCount}ê°œ)`;

                    // Store results for sorting
                    optimizationResults = results;
                    
                    // ì •ë ¬ ë° í‘œì‹œ
                    sortAndDisplayOptimizationResults();

                } catch (e) {
                    console.error("Optimization Error:", e);
                    alert("ìµœì í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê°œë°œì ë„êµ¬(F12)ë¥¼ í™•ì¸í•˜ì„¸ìš”: " + e.message);
                } finally {
                    progressDiv.classList.add('hidden');
                    resultArea.classList.remove('hidden');
                }

            }, 100);
        }

        // --- NEW: ì •ë ¬ ë° í‘œì‹œ í•¨ìˆ˜ (ì¬ì‚¬ìš© ê°€ëŠ¥) ---
        function sortAndDisplayOptimizationResults() {
            const tbody = document.getElementById('optTableBody');
            tbody.innerHTML = '';

            if (!optimizationResults || optimizationResults.length === 0) {
                // ê²°ê³¼ ì—†ìŒ ë©”ì‹œì§€ í‘œì‹œ
                tbody.innerHTML = `<tr><td colspan="15" class="py-4 text-center text-gray-500 font-bold">ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. í•„í„°(Limit)ë¥¼ ì™„í™”í•´ ì£¼ì„¸ìš”.</td></tr>`;
                return; 
            }

            const sortBy = document.getElementById('optSortBy').value;

            // ì •ë ¬
            optimizationResults.sort((a, b) => {
                if (sortBy === 'CAGR') return b.stats.cagr - a.stats.cagr;
                if (sortBy === 'TotalReturn') return b.stats.totalReturn - a.stats.totalReturn;
                if (sortBy === 'MDD') return b.stats.mdd - a.stats.mdd; 
                if (sortBy === 'Pain') return a.stats.painIndex - b.stats.painIndex; 
                if (sortBy === 'Calmar') return b.stats.calmar - a.stats.calmar;
                return 0;
            });

            // Top 10 í‘œì‹œ
            const top10 = optimizationResults.slice(0, 10);
            
            top10.forEach((r, idx) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 border-b border-gray-100";
                tr.innerHTML = `
                    <td class="py-2 px-2 text-center font-bold text-indigo-600">${idx + 1}</td>
                    <td class="py-2 px-2 text-right font-bold">${formatNum(r.stats.cagr)}%</td>
                    <td class="py-2 px-2 text-right text-red-500">${formatNum(r.stats.mdd)}%</td>
                    <td class="py-2 px-2 text-right text-orange-500">${formatNum(r.stats.painIndex)}%</td>
                    <td class="py-2 px-2 text-right">${formatNum(r.stats.totalReturn, 0)}%</td>
                    <td class="py-2 px-2 text-right bg-blue-50">${r.params.sfLoc.toFixed(1)}%</td>
                    <td class="py-2 px-2 text-right bg-blue-50">${r.params.sfProfit.toFixed(1)}%</td>
                    <td class="py-2 px-2 text-right bg-blue-50 text-gray-500">${r.params.sfSplit}</td>
                    <td class="py-2 px-2 text-right bg-blue-50 text-gray-500">${r.params.sfHold}</td>
                    <td class="py-2 px-2 text-right bg-red-50">${r.params.agLoc.toFixed(1)}%</td>
                    <td class="py-2 px-2 text-right bg-red-50">${r.params.agProfit.toFixed(1)}%</td>
                    <td class="py-2 px-2 text-right bg-red-50 text-gray-500">${r.params.agSplit}</td>
                    <td class="py-2 px-2 text-right bg-red-50 text-gray-500">${r.params.agHold}</td>
                    <td class="py-2 px-2 text-right bg-purple-50">${r.params.reinvestRate}%</td>
                    <td class="py-2 px-2 text-right bg-purple-50">${r.params.lossRate}%</td>
                    <td class="py-2 px-2 text-center">
                        <button class="text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded apply-btn">ì ìš©</button>
                    </td>
                `;
                
                tr.querySelector('.apply-btn').onclick = () => applyParams(r.params);
                tbody.appendChild(tr);
            });
        }

        function applyParams(p) {
            document.getElementById('sfLoc').value = p.sfLoc;
            document.getElementById('sfProfit').value = p.sfProfit;
            document.getElementById('sfSplit').value = p.sfSplit;
            document.getElementById('sfHold').value = p.sfHold;
            
            document.getElementById('agLoc').value = p.agLoc;
            document.getElementById('agProfit').value = p.agProfit;
            document.getElementById('agSplit').value = p.agSplit;
            document.getElementById('agHold').value = p.agHold;
            
            document.getElementById('reinvestRate').value = p.reinvestRate;
            document.getElementById('lossRate').value = p.lossRate;
            
            alert(`ì„¤ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.\në°±í…ŒìŠ¤íŠ¸ íƒ­ìœ¼ë¡œ ì´ë™í•˜ì—¬ ì‹¤í–‰í•´ ë³´ì„¸ìš”.`);
            switchTab('backtest');
        }

        // --- Visual Rendering Functions ---
        function getRandom(min, max) {
            return parseFloat((Math.random() * (max - min) + min).toFixed(1));
        }
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        function getRandomStep(min, max, step) {
            if (step <= 0) return min;
            const count = Math.floor((max - min) / step);
            const randomIdx = Math.floor(Math.random() * (count + 1));
            const val = min + (randomIdx * step);
            return parseFloat(val.toFixed(2));
        }

        function displayResults(result, startVal) {
            const history = result.history;
            const stats = result.stats;
            const dds = result.dds;

            document.getElementById('resultArea').classList.remove('hidden');

            // ìµœì¢… ìì‚°, ëˆ„ì  ìˆ˜ìµë¥  ì •ìˆ˜ í‘œì‹œ (ì†Œìˆ˜ì  0ìë¦¬)
            document.getElementById('resFinalValue').innerText = `$${formatNum(stats.finalValue, 0)}`;
            document.getElementById('resTotalReturn').innerText = `${formatNum(stats.totalReturn, 0)}%`;
            
            document.getElementById('resTotalReturn').className = `text-xl font-extrabold mt-1 ${stats.totalReturn >= 0 ? 'text-red-500' : 'text-blue-600'}`;
            document.getElementById('resCagr').innerText = `${formatNum(stats.cagr)}%`;
            document.getElementById('resMdd').innerText = `${formatNum(stats.mdd)}%`;
            document.getElementById('resPain').innerText = `${formatNum(stats.painIndex)}%`;
            document.getElementById('resGpr').innerText = formatNum(stats.gpr);
            document.getElementById('resCalmar').innerText = formatNum(stats.calmar);
            document.getElementById('resWinRate').innerText = `${formatNum(stats.winRate)}%`;
            const pfStr = stats.profitFactor === 999 ? 'Inf' : formatNum(stats.profitFactor);
            document.getElementById('resProfitFactor').innerText = pfStr;
            
            const annualMetrics = calculateAnnualMetrics(history, startVal);
            drawAnnualMetrics(annualMetrics);
            drawChart(history, dds);
            drawRateChart(history); 
            drawTable(history);
        }
        
        function calculateAnnualMetrics(history, initialCapital) {
             if (history.length === 0) return [];
            let annualMetrics = [];
            let currentYear = history[0].date.getFullYear();
            let yearData = [];
            let startValue = initialCapital;
            let startCumulativeProfit = 0;
            let startCumulativeWithdrawal = 0;
            
            for (let i = 0; i < history.length; i++) {
                const h = history[i];
                const year = h.date.getFullYear();
                if (year !== currentYear) {
                    if (yearData.length > 0) {
                        const endValue = yearData[yearData.length - 1].val;
                        const endCumulativeProfit = yearData[yearData.length - 1].profit; 
                        const endCumulativeWithdrawal = yearData[yearData.length - 1].cumulativeWithdrawal; 
                        const totalReturn = ((endValue - startValue) / startValue) * 100;
                        let maxPeak = startValue;
                        let annualMDD = 0;
                        yearData.forEach(d => {
                            if (d.val > maxPeak) maxPeak = d.val;
                            const dd = ((d.val - maxPeak) / maxPeak) * 100;
                            if (dd < annualMDD) annualMDD = dd;
                        });
                        const annualRealizedProfit = endCumulativeProfit - startCumulativeProfit;
                        const annualWithdrawal = endCumulativeWithdrawal - startCumulativeWithdrawal;
                        let withdrawalRatioVsProfit = 0;
                        if (annualRealizedProfit > 0) {
                            withdrawalRatioVsProfit = (annualWithdrawal / annualRealizedProfit) * 100;
                        }
                        annualMetrics.push({
                            year: currentYear, startValue: startValue, endValue: endValue,
                            annualReturn: totalReturn, annualMDD: annualMDD,
                            annualRealizedProfit: annualRealizedProfit, 
                            cumulativeWithdrawal: annualWithdrawal, 
                            withdrawalRatioVsProfit: withdrawalRatioVsProfit 
                        });
                        startValue = endValue;
                        startCumulativeProfit = endCumulativeProfit; 
                        startCumulativeWithdrawal = endCumulativeWithdrawal; 
                        currentYear = year;
                        yearData = [];
                    }
                }
                yearData.push(h);
            }
            if (yearData.length > 0) {
                const endValue = yearData[yearData.length - 1].val;
                const endCumulativeProfit = yearData[yearData.length - 1].profit;
                const endCumulativeWithdrawal = yearData[yearData.length - 1].cumulativeWithdrawal;
                const totalReturn = ((endValue - startValue) / startValue) * 100;
                let maxPeak = startValue;
                let annualMDD = 0;
                yearData.forEach(d => {
                    if (d.val > maxPeak) maxPeak = d.val;
                    const dd = ((d.val - maxPeak) / maxPeak) * 100;
                    if (dd < annualMDD) annualMDD = dd;
                });
                const annualRealizedProfit = endCumulativeProfit - startCumulativeProfit;
                const annualWithdrawal = endCumulativeWithdrawal - startCumulativeWithdrawal;
                let withdrawalRatioVsProfit = 0;
                if (annualRealizedProfit > 0) {
                    withdrawalRatioVsProfit = (annualWithdrawal / annualRealizedProfit) * 100;
                }
                annualMetrics.push({
                    year: currentYear, startValue: startValue, endValue: endValue,
                    annualReturn: totalReturn, annualMDD: annualMDD,
                    annualRealizedProfit: annualRealizedProfit,
                    cumulativeWithdrawal: annualWithdrawal,
                    withdrawalRatioVsProfit: withdrawalRatioVsProfit
                });
            }
            return annualMetrics;
        }

        function drawAnnualMetrics(annualMetrics) {
            const tbody = document.getElementById('annualMetricsTableBody');
            tbody.innerHTML = '';
            annualMetrics.forEach(m => {
                const returnClass = m.annualReturn >= 0 ? 'text-red-600 font-bold' : 'text-blue-600 font-bold';
                const mddClass = m.annualMDD >= 0 ? 'text-gray-600' : 'text-red-600';
                const profitClass = m.annualRealizedProfit >= 0 ? 'text-red-600 font-bold' : 'text-blue-600 font-bold';
                const ratioClass = m.withdrawalRatioVsProfit > 0 && m.withdrawalRatioVsProfit <= 100 ? 'text-purple-700 font-bold' : (m.withdrawalRatioVsProfit > 100 ? 'text-red-700 font-bold' : 'text-gray-400');
                const row = `
                    <tr class="hover:bg-gray-50 transition-colors border-b border-gray-100">
                        <td class="py-2 px-3 text-center font-bold">${m.year}</td>
                        <td class="py-2 px-2 text-right">${formatNum(m.startValue, 0)}</td>
                        <td class="py-2 px-2 text-right">${formatNum(m.endValue, 0)}</td>
                        <td class="py-2 px-2 text-right ${returnClass}">${formatNum(m.annualReturn, 2)}%</td>
                        <td class="py-2 px-2 text-right ${mddClass}">${formatNum(m.annualMDD, 2)}%</td>
                        <td class="py-2 px-2 text-right ${profitClass}">${formatNum(m.annualRealizedProfit, 0)}</td>
                        <td class="py-2 px-2 text-right text-indigo-700 font-bold">${formatNum(m.cumulativeWithdrawal, 2)}</td>
                        <td class="py-2 px-2 text-right ${ratioClass}">${formatNum(m.withdrawalRatioVsProfit, 2)}%</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function drawChart(history, dds) {
            const ctx = document.getElementById('strategyChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            const labels = history.map(h => h.date.toISOString().slice(0, 10));
            const dataVal = history.map(h => h.val);
            const dataClose = history.map(h => h.close);
            const dataDD = dds.map(d => d * 100);
            const dataWithdrawal = history.map(h => h.cumulativeWithdrawal);

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ìì‚° ê°€ì¹˜ ($)', data: dataVal, borderColor: 'rgb(75, 192, 192)', backgroundColor: 'rgba(75, 192, 192, 0.1)', yAxisID: 'y', tension: 0.1, pointRadius: 0, fill: false },
                        { label: 'SOXL ì£¼ê°€ ($)', data: dataClose, borderColor: 'rgb(255, 99, 132)', yAxisID: 'y1', tension: 0.1, pointRadius: 1, borderWidth: 1, fill: false },
                        { label: 'ëˆ„ì  ì¸ì¶œì•¡ ($)', data: dataWithdrawal, borderColor: 'rgb(100, 100, 200)', backgroundColor: 'rgba(100, 100, 200, 0.1)', yAxisID: 'y', tension: 0.1, pointRadius: 0, fill: false },
                        { label: 'Drawdown (%)', data: dataDD, borderColor: 'rgba(153, 102, 255, 0.8)', backgroundColor: 'rgba(153, 102, 255, 0.2)', yAxisID: 'y2', type: 'line', fill: true, pointRadius: 0, borderWidth: 1 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { ticks: { maxTicksLimit: 8, maxRotation: 0 } },
                        y: { position: 'right', grid: { display: false }, title: { display: true, text: 'Asset Value / Withdrawal ($)' } },
                        y1: { position: 'left', grid: { color: '#f3f4f6' }, title: { display: true, text: 'SOXL Price ($)' } },
                        y2: { position: 'right', min: -100, max: 0, display: false }
                    },
                    plugins: { tooltip: { callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) label += ': '; if (context.parsed.y !== null) { label += formatNum(context.parsed.y); if (context.dataset.yAxisID === 'y2') label += '%'; } return label; } } } }
                }
            });
        }

        function drawRateChart(history) {
            const ctx = document.getElementById('rateChart').getContext('2d');
            if (rateChartInstance) rateChartInstance.destroy();
            const labels = history.map(h => h.date.toISOString().slice(0, 10));
            const dataReinvest = history.map(h => h.effReinvestRate);
            const dataLoss = history.map(h => h.effLossRate);
            const dataWithdraw = history.map(h => h.withdrawRate);

            rateChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ìˆ˜ìµ ì‹œ ë°˜ì˜ë¥  (%)', data: dataReinvest, borderColor: 'rgb(34, 197, 94)', backgroundColor: 'rgba(34, 197, 94, 0.1)', borderWidth: 2, pointRadius: 0, fill: false },
                        { label: 'ì†ì‹¤ ì‹œ ë°˜ì˜ë¥  (%)', data: dataLoss, borderColor: 'rgb(239, 68, 68)', backgroundColor: 'rgba(239, 68, 68, 0.1)', borderWidth: 2, pointRadius: 0, fill: false },
                        { label: 'ì¸ì¶œë¥  (%)', data: dataWithdraw, borderColor: 'rgb(147, 51, 234)', backgroundColor: 'rgba(147, 51, 234, 0.1)', borderWidth: 1, pointRadius: 0, borderDash: [5, 5], fill: true }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { ticks: { maxTicksLimit: 8, maxRotation: 0 } },
                        y: { position: 'left', title: { display: true, text: 'Rate (%)' }, min: 0, suggestedMax: 100 }
                    },
                    plugins: { tooltip: { callbacks: { label: function(context) { return context.dataset.label + ': ' + context.parsed.y.toFixed(4) + '%'; } } } }
                }
            });
        }

        function drawTable(history) {
            const tbody = document.getElementById('logTableBody');
            tbody.innerHTML = '';
            
            const rows = history.map((h, i) => {
                const dateStr = h.date.toISOString().slice(0, 10);
                let priceDecimals = 2;
                if (h.date >= DECIMAL_4_START && h.date <= DECIMAL_4_END) priceDecimals = 4;
                
                const modeClass = h.mode === 'AG' ? 'text-red-500 font-bold' : 'text-blue-500 font-bold';
                const buyClass = h.buyQty > 0 ? 'bg-blue-50 font-bold text-blue-600' : 'text-gray-300';
                
                let sellDateStr = '-';
                if (h.newPort) {
                    if (h.newPort.sellDate) sellDateStr = `<span class="text-red-600 font-bold">${h.newPort.sellDate.toISOString().slice(0, 10)}</span>`;
                    else sellDateStr = '<span class="text-gray-400 text-[10px]">ë³´ìœ ì¤‘</span>';
                }
                
                let precSeed = 0; 
                if (h.date >= DECIMAL_4_START && h.date <= DECIMAL_4_END) precSeed = 2;
                const withdrawnAmountStr = h.withdrawnAmount > 0 ? formatNum(h.withdrawnAmount, precSeed) : '-';
                const withdrawnClass = h.withdrawnAmount > 0 ? 'font-bold text-indigo-700 bg-indigo-50/50' : 'text-gray-400';
                const ddClass = h.dd < 0 ? 'text-blue-600' : 'text-gray-300';
                const targetSellStr = h.targetSell > 0 ? formatNum(h.targetSell, priceDecimals) : '-';

                let changeRate = 0;
                if (i > 0) {
                    const prevClose = history[i-1].close;
                    changeRate = ((h.close - prevClose) / prevClose) * 100;
                }
                const changeClass = changeRate >= 0 ? 'text-red-600' : 'text-blue-600';
                const changeSign = changeRate >= 0 ? '+' : '';
                const profitClass = h.profit >= 0 ? 'text-red-600' : 'text-blue-600';

                return `
                    <tr class="hover:bg-gray-50 transition-colors border-b border-gray-100">
                        <td class="py-2 px-2 text-center text-xs text-gray-500 sticky left-0 bg-white border-r border-gray-100">${dateStr}</td>
                        <td class="py-2 px-2 text-right font-medium text-gray-700">${formatNum(h.close, priceDecimals)}</td>
                        <td class="py-2 px-2 text-right text-[11px] ${changeClass}">${changeSign}${formatNum(changeRate)}%</td>
                        <td class="py-2 px-2 text-center text-xs ${modeClass}">${h.mode}</td>
                        <td class="py-2 px-2 text-right text-gray-600 font-mono">${formatNum(h.capital, 0)}</td>
                        <td class="py-2 px-2 text-right text-gray-400 font-mono">${formatNum(h.bp, 0)}</td>
                        <td class="py-2 px-2 text-center ${buyClass}">${h.buyQty > 0 ? h.buyQty : '-'}</td>
                        <td class="py-2 px-2 text-center font-bold text-gray-600">${h.cnt}</td>
                        <td class="py-2 px-2 text-right text-blue-600 bg-blue-50/50 text-[11px]">${targetSellStr}</td>
                        <td class="py-2 px-2 text-center bg-red-50/50">${sellDateStr}</td>
                        <td class="py-2 px-2 text-right ${withdrawnAmountStr !== '-' ? withdrawnClass : 'text-gray-400'}">${withdrawnAmountStr}</td>
                        <td class="py-2 px-2 text-right font-bold text-gray-800">${formatNum(h.val, 0)}</td>
                        <td class="py-2 px-2 text-right text-gray-400 font-mono">${formatNum(h.cash, 0)}</td>
                        <td class="py-2 px-2 text-right font-medium ${profitClass}">${formatNum(h.profit, 0)}</td>
                        <td class="py-2 px-2 text-right text-gray-500">${formatNum(h.qty, 0)}</td>
                        <td class="py-2 px-2 text-right ${ddClass} border-l border-gray-100">${formatNum(h.dd, 2)}%</td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = rows;
        }
    </script>
</body>
</html>